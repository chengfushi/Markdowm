[toc]
# 1.进程同步的基本概念
## 1.1进程同步的主要任务
进程同步的主要任务，是使并发执行的诸进程之间能有效的共享资源和相互合作，从而使程序的
执行具有可再现性。
## 1.2两种形式的制约关系
在多道程序环境下，当程序并发执行时，由于**资源共享**和**进程合作**，使同处于系统中的诸进程之间存在两种形式的制约关系。

| 制约类型         | 关系描述                                                                                   | 例子                                                                                   | 也叫做       |
|------------------|--------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------|--------------|
| 直接相互制约关系 | 进程之间的合作关系，进程A向进程B提供数据，若缓冲区未填充，B阻塞；若缓冲区满，A阻塞。   | 进程A写数据到缓冲区，进程B从缓冲区读取数据。若缓冲区为空，B阻塞；缓冲区满，A阻塞。 | 同步         |
| 间接相互制约关系 | 进程间的资源共享，进程A和进程B共享打印机，若A请求时资源被B占用，A阻塞直到B释放。 | 进程A请求打印机资源，若已被进程B占用，则A阻塞直到B释放资源。                        | 互斥         |
## 1.3临界资源与临界区
| 术语               | 描述                                                                                             | 说明                                                                                                   |
|--------------------|--------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------|
| 临界资源 (Critical Resource) | 一次仅允许一个进程使用的资源。硬件或软件临界资源都只能通过互斥方式被多个进程访问。            | 多个进程需要以互斥方式访问临界资源，确保同一时刻只有一个进程能使用该资源。                             |
| 临界区 (Critical Section)   | 在每个进程中访问临界资源的那段代码。                                                                | 由于不同进程共享公用数据或变量而引起的程序段。临界区也可称为访问公用数据的代码部分。                  |
| 进入区 (Entry Section)      | 进程进入临界区之前所执行的代码，用于检查临界资源是否正在被其他进程访问。                         | 如果临界资源未被占用，进程可进入临界区并设定资源访问标志。                                            |
| 退出区 (Exit Section)       | 进程执行临界区后需要执行的代码，用于恢复临界资源访问标志，标记资源为未被访问。                    | 退出区确保其他进程能够访问临界资源，将访问标志恢复为“未被占用”。                                      |
## 1.4同步机制
同步机制：即 OS从进程管理者的角度处理同步问题。
同步机制的规则：

| 规则               | 描述                                                                                 | 说明                                                                                                   |
|--------------------|--------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------|
| 空闲让进 (Free Entry)  | 当没有进程处于临界区时，应允许一个进程进入临界区。                                     | 确保当临界区空闲时，进程能够进入临界区使用资源。                                                       |
| 忙则等待 (Busy Wait)   | 当已有进程进入临界区时，其他进程必须等待。                                             | 防止多个进程同时进入临界区，避免资源冲突，要求等待的进程在其他进程退出临界区后再尝试进入。              |
| 有限等待 (Bounded Waiting) | 对要求访问临界资源的进程，应保证在有限时间内进入自己的临界区，防止“死等”。               | 确保进程不会因为其他进程一直占用临界区而无限期地等待，避免“死锁”或“饥饿”现象。                       |
| 让权等待 (Give Up Wait)  | 当进程不能进入自己的临界区时，应立即释放处理机，防止“忙等”。                           | 防止进程因无法进入临界区而不断占用处理机，导致系统资源浪费或其他进程无法得到执行机会。                 |
# 2.信号量机制
## 2.1信号量的基本概念
1965年，荷兰学者Dijkstra提出的信号量（Semaphores）机制是一种有效的进程同步工具。  
信号量表示资源的实体，是一个与队列有关的整型变量。
数据结构定义如下：

```c
struct semaphore {
    int value;               // 信号量的值
    pointer_PCB queue;       // 阻塞在该信号量的各个进程的标识
}
```

## 2.2OS利用信号量对进程和资源进行控制和管理
信号量**初值**表示系统中可共享资源的**总数**，不能为负。 在执行过程中，信号量的取值为非负值时，表示当前可用资源数； 若信号量为负值，其绝对值表示系统中处于阻塞状态（正在等待资源）的进程数。

| 信号量类型        | 用途                               | 初值                           | 操作权限                                   |
|-------------------|------------------------------------|--------------------------------|--------------------------------------------|
| 公用/互斥信号量    | 用来实现进程间的互斥                | 初值为1                        | 允许它所联系的一组进程对其执行P/V操作       |
| 私用/同步信号量    | 用来实现进程间的同步                | 初值为0或某个正整数            | 仅允许拥有它的进程对其执行P/V操作          |
## 2.3P/V操作
| 操作类型 | 名称 | 作用描述 | 操作条件 | 结果 |
|----------|------|----------|----------|------|
| P操作    | Proberen（尝试） | 申请资源或进入临界区 | 信号量值大于0时，信号量减1；信号量为0时，进程阻塞等待 | 如果信号量大于0，信号量减1并继续执行；如果信号量为0，进程被阻塞 |
| V操作    | Verhogen（增加） | 释放资源或退出临界区 | 信号量值增加1 | 信号量增加1，若有阻塞进程，唤醒一个进程继续执行 |
- **P操作**：尝试进入临界区或申请资源，若信号量大于0，则信号量减1；若信号量为0，则进程阻塞等待。
- **V操作**：释放资源或退出临界区，信号量加1，若有阻塞进程，则唤醒一个进程继续执行。

**用P、V原语实现进程互斥**
互斥:一组并发进程中的一个或多个程序段，因共享某一公有资源而导致它们必须以一个不允许交叉执行的单位执行。即不允许两个以上的共享该资源的并发进程同时进入临界区。
设信号量mutex是用于互斥的信号量，且其为1表示没有并发进
程使用该临界区。只要把临界区臵于P(mutex)和V(mutex)之间即可实现进程间的互斥。
![[PCC3_1.png]]

## 2.4利用信号量实现前趋关系
设有两个并发进程P1和P2。P1中有语句S1，P2中有语句S2，希望在执行完S1后执行S2
为实现这种前趋关系，可让进程P1和P2共享一个公用信号量S，并赋初值为0，将V(S)操作放在语句S1后面；而在S2语句前插入P(S)操作
 进程P1， S1;V(S);
 进程P2， P(S); S2;
由于S被初始化为0，若P2先执行，必定阻塞，只有在进程P1执行完使S增为1后，P2才能执行S2操作
## 2.5利用信号量实现进程同步

| 同步 | 描述 |
| --- | --- |
| 同步定义 | 异步环境下的一组并发进程因直接制约而互相发送消息而进行互相合作、互相等待，使得各进程按一定的速度执行的过程。 |
| 异步环境 | 相互合作的一组并发进程，每个进程都以各自独立的、不可预知的速度向前推进，但它们又需要密切合作，以实现一个共同的任务。 |
| 同步实质 | 使各合作进程的行为保持某种一致性或不变性。 |
## 2.6生产者－消费者问题
生产者-消费者问题（Producer-Consumer Problem），也称为有界缓冲区问题（Bounded-Buffer Problem），是一个经典的并发编程问题，用于描述两种类型的进程（生产者和消费者）如何协调对共享资源（通常是缓冲区）的访问。这个问题的关键在于确保生产者不会在缓冲区满时向其添加数据，消费者也不会在缓冲区空时尝试从中读取数据。
### 2.6.1问题描述
- **生产者（Producer）**：生产者的任务是生成数据并将其放入缓冲区。
- **消费者（Consumer）**：消费者的任务是从缓冲区取出数据并进行处理。
- **缓冲区（Buffer）**：一个固定大小的存储区域，用于临时存放生产者生成的数据。

### 2.6.2问题难点
1. **同步**：需要确保生产者和消费者之间的操作是同步的，以避免缓冲区溢出（生产者添加数据时缓冲区已满）或下溢（消费者读取数据时缓冲区为空）。
2. **互斥**：需要确保任一时刻只有一个生产者或消费者能够访问缓冲区，以避免数据不一致。
3. **死锁**：需要避免生产者和消费者相互等待对方释放资源的情况，这可能导致程序无法继续执行。

### 2.6.3解决方案
解决生产者-消费者问题通常需要使用同步原语，如信号量或互斥锁（mutex）。以下是使用信号量的一个常见解决方案：

- **互斥信号量（mutex）**：用于确保对缓冲区的互斥访问。
- **计数信号量（empty）**：表示缓冲区中空闲位置的数量。
- **计数信号量（full）**：表示缓冲区中已占用位置的数量。

### 2.6.4算法步骤

1. **生产者**：
   - 等待`empty`信号量（如果缓冲区没有空闲位置，则等待）。
   - 等待`mutex`信号量（确保互斥访问缓冲区）。
   - 向缓冲区添加数据。
   - 释放`mutex`信号量（允许其他进程访问缓冲区）。
   - 增加`full`信号量（表示缓冲区中有一个新数据）。

2. **消费者**：
   - 等待`full`信号量（如果缓冲区没有数据，则等待）。
   - 等待`mutex`信号量（确保互斥访问缓冲区）。
   - 从缓冲区取出数据。
   - 释放`mutex`信号量（允许其他进程访问缓冲区）。
   - 增加`empty`信号量（表示缓冲区中有一个空闲位置）。

![[PCC3_2.png]]
